name: Python Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # é€±ã«ä¸€å›ã®å®šæœŸå®Ÿè¡Œï¼ˆSchedulerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®CICDé€£æºç”¨ï¼‰
  schedule:
    - cron: '0 0 * * 0'  # æ¯é€±æ—¥æ›œæ—¥ã®åˆå‰0æ™‚ã«å®Ÿè¡Œ

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov flake8 pytest-html
        pip install -e .
        
    - name: Lint with flake8
      run: |
        # E501: Line too long
        # E203: Whitespace before ':'
        # W503: Line break before binary operator
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --max-complexity=10 --max-line-length=127 --statistics
        
    - name: Test with pytest and coverage
      run: |
        mkdir -p test-results
        pytest --cov=src/arxiv_harvester --cov-report=xml:coverage.xml --cov-report=html:coverage_html --html=test-results/report.html --self-contained-html tests/
      
    - name: Upload test coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
        verbose: true
        
    - name: Upload test coverage report
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report-${{ matrix.python-version }}
        path: coverage_html/
        retention-days: 14
        
    - name: Upload test report
      uses: actions/upload-artifact@v3
      with:
        name: test-report-${{ matrix.python-version }}
        path: test-results/
        retention-days: 14
        
    - name: Check test results
      id: test-results
      run: |
        if [ -f test-results/report.html ]; then
          echo "::set-output name=status::success"
        else
          echo "::set-output name=status::failure"
        fi

  # PR ã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆä»˜ä¸
  comment-pr:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3
        
      - name: Find test results
        run: |
          echo "## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ ğŸ“Š" > comment.md
          echo "" >> comment.md
          echo "### Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ¥ãƒ†ã‚¹ãƒˆçŠ¶æ³" >> comment.md
          echo "| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | çŠ¶æ…‹ |" >> comment.md
          echo "| --- | --- |" >> comment.md
          
          for version in 3.9 3.10 3.11 3.12; do
            if [ -d "test-report-$version" ]; then
              echo "| Python $version | âœ… æˆåŠŸ |" >> comment.md
            else
              echo "| Python $version | âŒ å¤±æ•— |" >> comment.md
            fi
          done
          
          echo "" >> comment.md
          echo "è©³ç´°ãªãƒ†ã‚¹ãƒˆçµæœã¨ç¶²ç¾…ç‡ãƒ¬ãƒãƒ¼ãƒˆã¯ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚" >> comment.md
      
      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('comment.md', 'utf8');
            const issue_number = context.issue.number;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: comment
            });

  # Slacké€šçŸ¥ã‚¸ãƒ§ãƒ–
  notify:
    needs: test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check workflow result
        id: check
        run: |
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "::set-output name=status::success"
            echo "::set-output name=color::#36a64f"
            echo "::set-output name=icon::white_check_mark"
            echo "::set-output name=title::ãƒ†ã‚¹ãƒˆæˆåŠŸ"
          else
            echo "::set-output name=status::failure"
            echo "::set-output name=color::#ff0000"
            echo "::set-output name=icon::x"
            echo "::set-output name=title::ãƒ†ã‚¹ãƒˆå¤±æ•—"
          fi

      - name: Send notification to Slack
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ steps.check.outputs.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            ${{ steps.check.outputs.title }} - ${{ github.repository }}
            ${{ github.workflow }} ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ (${{ github.event_name }})
            å®Ÿè¡Œè€…: ${{ github.actor }}
            ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}
            è©³ç´°: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          MATRIX_CONTEXT: ${{ toJson(matrix) }}

  # å®šæœŸå®Ÿè¡Œæ™‚ã®arXivè«–æ–‡åé›†å‡¦ç†
  harvest-papers:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && needs.test.result == 'success'
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          
      - name: Run arXiv harvester
        run: |
          python -m arxiv_harvester.run --force-run
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
